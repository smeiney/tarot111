# 塔罗牌游戏设计文档

## 一、项目概述
本项目是一个单 HTML 文件的塔罗牌游戏，提供神秘、酷炫的 3D 视觉体验与手势交互。玩家通过摄像头手势（区域位置与握拳）控制牌阵滚动并选择中间牌，完成三张牌的抽取后，通过张开五指手势进入 AI 解读阶段。若配置 DeepSeek API Token，则流式生成 AI 解读；未配置时仅展示牌面与基础含义。

## 二、目标与非目标
### 目标
- 单 HTML 文件即可运行
- 三张牌抽取与解读流程符合塔罗规则
- 3D 视觉效果、神秘氛围、酷炫动画（粒子特效、发光反馈）
- 专业塔罗牌正面图 (Rider-Waite-Smith)
- 牌阵横向排列，支持宽屏响应式布局
- 摄像头手势控制：区域变速滚动、握拳选牌、张开五指启动/解读
- 集成 DeepSeek 官方 API (deepseek-chat) 流式解读
- 本地存储 API Key

### 非目标
- 多人对战或社交功能
- 后端服务部署
- 多语言支持（目前界面为中文）

## 三、用户体验与流程
1. **启动**：进入页面，背景星空与雾效。用户允许摄像头权限后，**张开五指保持 3 秒**启动游戏。
2. **开场**：牌阵从左侧飞入并展开，进入洗牌与发牌动画。
3. **选牌**：
   - **滚动**：手移动到屏幕左侧/右侧区域，控制牌阵向左/右滚动，速度随距离边缘的距离变化。
   - **选中**：手移动到屏幕中间区域，**握拳保持 1 秒**选中当前中间的牌。蓄力过程中有进度条与粒子光效反馈。
4. **揭示**：依次选满 3 张牌后，展示翻牌动画。
5. **解读**：
   - 界面提示“张开五指保持 3 秒，开启命运解读”。
   - 用户**张开五指保持 3 秒**，触发 AI 解读请求。
   - 弹出模态框，流式展示 DeepSeek 模型生成的 Markdown 格式解读结果。

## 四、核心玩法规则
### 牌数与阵型
- 固定抽取 3 张牌
- 牌阵横向排列，依序代表：过去、现在、未来

### 选牌逻辑
- 牌阵中始终只有中间牌处于可选状态
- 握拳蓄力机制防止误触，需持续 1 秒
- 选中后牌自动飞入待开牌区域，牌阵自动补位

## 五、视觉与交互设计
### 视觉风格
- 背景：暗色星空 + 动态雾效
- 光效：选中时亮白色发光、粒子飞升特效
- 反馈：手势光标拖尾、蓄力进度条、文字提示
- 界面：金色线条、Cinzel 字体、神秘学元素

### 3D 效果
- 使用 CSS 3D (perspective + rotateY + translateZ)
- 滚动时卡牌呈弧形排列
- 翻牌动画平滑过渡

### 卡牌材质
- 正面：使用 https://sacred-texts.com/tarot/pkt/ 页面中的专业塔罗牌图像 (Rider-Waite-Smith Deck)
- 背面：统一神秘花纹与纹理

## 六、技术方案
### 单 HTML 文件
所有 CSS 与 JS 内联在单个 HTML 文件中，资源按需通过 CDN 加载：
- 手势识别：MediaPipe Hands CDN
- Markdown 渲染：Marked.js CDN
- 字体：Google Fonts (Cinzel)

### 核心模块划分
1. **初始化与资源**：图片预加载、MediaPipe 设置
2. **状态管理**：IDLE, INTRO, PICKING, REVEALING, INTERPRETING
3. **渲染引擎**：requestAnimationFrame 循环，处理 3D 变换与粒子系统
4. **手势逻辑**：
   - `isOpenPalm`: 计算指尖与手腕距离
   - `isFist`: 计算指尖与手掌距离
   - 区域判定：屏幕左/中/右三分区
5. **AI 服务**：Fetch API 调用 DeepSeek Chat Completions，处理 Stream 响应

## 七、数据结构设计
### 牌数据
- id (int)
- name (string)
- nameCN (string)
- upright (string)
- reversed (string)
- image (string)

### 游戏状态
- currentState (STATE enum)
- currentDeck (Array)
- pickedCards (Array)
- velocity (float)
- targetIndex (float)
- handLandmarks (Object)

## 八、手势识别
### 动作定义
- **区域滚动**：
  - 手在屏幕左 1/3：向右滚动（速度随距离增加）
  - 手在屏幕右 1/3：向左滚动（速度随距离增加）
  - 手在中间 1/3：停止滚动，进入可选状态
- **握拳选牌**：
  - 在中间区域检测到握拳
  - 触发蓄力（进度条 + 粒子）
  - 保持 1 秒后确认选择
- **五指张开**：
  - 检测五指伸展
  - 用于 **开始游戏** 和 **触发解读**
  - 需保持 3 秒蓄力

### 交互约束
- 状态机隔离：不同阶段响应不同手势
- 进度重置：中途动作中断，蓄力进度条归零

## 九、AI 解读模块
### 触发条件
- 3 张牌选定并翻开
- 用户执行张开五指手势
- 本地存储中存在 API Key

### 解读请求
- 模型：deepseek-chat
- 提示词：扮演神秘塔罗师，结合心理学与灵性，Markdown 格式输出
- 模式：Stream 流式传输，实时打字机效果

### Token 处理
- 设置按钮弹窗配置
- 存储于 `localStorage`，持久化保存

## 十、安全与隐私
- 摄像头数据仅在浏览器本地内存处理，不上传服务器
- API Key 存储在本地 localStorage，直接请求 DeepSeek API，不经过中间服务器

## 十一、性能与兼容性
- 响应式布局：适配宽屏与窄屏，动态计算卡牌间距
- 性能优化：使用 CSS transform 硬件加速，限制粒子数量

## 十二、测试与验证
- 验证手势在不同光照下的识别率
- 验证 API 流式输出的稳定性
- 验证宽屏下的牌阵显示效果

